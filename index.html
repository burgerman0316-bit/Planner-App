<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Agenda Pro | V3.4.2</title>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        :root {
            --bg: #000000; --card: #1c1c1e; --border: #2c2c2e; --text: #ffffff;
            --dim: #8e8e93; --accent: #ffd60a; --error: #ff375f;
            --input-bg: #1c1c1e; --icon-color: #ffffff;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        /* Full Theme Engine */
        body.theme-midnight { --bg: #000; --card: #1c1c1e; --accent: #ffd60a; --icon-color: #ffd60a; }
        body.theme-solar { --bg: #1a1a1a; --card: #242424; --accent: #ffb300; --icon-color: #ffb300; }
        body.theme-cyber { --bg: #05010d; --card: #12042b; --accent: #ff00ff; --icon-color: #ff00ff; }
        body.theme-forest { --bg: #0d140e; --card: #1a241c; --accent: #5efc82; --icon-color: #5efc82; }
        body.theme-silver { --bg: #f2f2f7; --card: #ffffff; --accent: #007aff; --text: #000; --border: #d1d1d6; --input-bg: #e5e5ea; --icon-color: #007aff; }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, system-ui, sans-serif; user-select: none; -webkit-user-select: none; }
        input { user-select: text; -webkit-user-select: text; }
        body { margin: 0; background: var(--bg); color: var(--text); overflow: hidden; height: 100vh; display: flex; flex-direction: column; transition: 0.4s; }

        /* Loader */
        #global-loader { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 20px; transition: opacity 0.5s; }
        .spinner { width: 32px; height: 32px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Auth UI */
        .full-screen { position: fixed; inset: 0; background: #000; z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 30px; overflow-y: auto; text-align: center; }
        .auth-container { width: 100%; max-width: 400px; display: none; flex-direction: column; gap: 12px; }
        .auth-container.active { display: flex; }
        .auth-container h1 { font-size: 54px; letter-spacing: -4px; margin-bottom: 20px; }
        .subtitle { font-size: 11px; letter-spacing: 3px; color: var(--dim); text-transform: uppercase; margin-bottom: 30px; font-weight: 700; }
        
        .btn-prime { width: 100%; padding: 18px; border-radius: 20px; border: none; font-weight: 900; text-transform: uppercase; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-prime:active { transform: scale(0.98); }
        .btn-add { background: var(--text); color: var(--bg); }
        .btn-save { background: var(--accent); color: #000; }
        .btn-ghost { background: transparent; color: var(--dim); border: 1px solid var(--border); margin-top: 10px; }
        .btn-danger { background: rgba(255, 55, 95, 0.1); color: var(--error); border: 1px solid var(--error); }

        .error-msg { color: var(--error); font-size: 13px; font-weight: 600; min-height: 20px; }

        /* App Shell */
        #app-shell { display: none; flex-direction: column; height: 100vh; transition: 0.6s cubic-bezier(0.16, 1, 0.3, 1); opacity: 0; }
        #app-shell.ready { opacity: 1; }
        #app-shell.modal-active { transform: scale(0.94); filter: blur(20px); pointer-events: none; }

        header { padding-top: calc(var(--safe-top) + 20px); padding-bottom: 10px; background: var(--bg); border-bottom: 1px solid var(--border); z-index: 100; flex-shrink: 0; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 25px; }
        .header-top h1 { margin: 0; font-size: 34px; font-weight: 900; letter-spacing: -1.5px; }

        .icon-btn { cursor: pointer; display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; color: var(--icon-color); }
        .icon-btn svg { width: 28px; height: 28px; fill: none; stroke: currentColor; stroke-width: 2.5; stroke-linecap: round; stroke-linejoin: round; }

        .nav-scroller { display: flex; gap: 12px; overflow-x: auto; padding: 5px 25px 15px; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
        .nav-scroller::-webkit-scrollbar { display: none; }

        .tab-pill { flex-shrink: 0; padding: 10px 22px; border-radius: 50px; background: var(--card); color: var(--dim); font-size: 13px; font-weight: 800; border: 1px solid var(--border); transition: 0.2s ease; cursor: pointer; }
        .tab-pill.active { background: var(--accent); color: #000; border-color: var(--accent); transform: scale(1.02); }

        main { flex: 1; overflow-y: auto; padding: 25px; padding-bottom: 300px; }
        .month-label { font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: var(--accent); font-weight: 900; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; }
        .month-label::after { content: ""; height: 1px; background: var(--border); flex: 1; }

        .card { background: var(--card); border: 1px solid var(--border); border-radius: 24px; padding: 20px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; position: relative; overflow: hidden; }
        .card-body b { display: block; font-size: 17px; margin-bottom: 4px; }
        .card-body span { font-size: 13px; color: var(--dim); }
        .trash-icon { width: 20px; height: 20px; fill: none; stroke: var(--error); stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; cursor: pointer; }

        /* Modals */
        .modal-overlay { position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.7); display: none; align-items: flex-end; justify-content: center; opacity: 0; transition: 0.4s; backdrop-filter: blur(8px); }
        .modal-overlay.active { display: flex; opacity: 1; }
        .modal-sheet { background: var(--card); width: 100%; max-width: 500px; border-radius: 40px 40px 0 0; padding: 30px; padding-bottom: calc(var(--safe-bottom) + 10px); transform: translateY(100%); transition: 0.5s cubic-bezier(0.16, 1, 0.3, 1); border-top: 1px solid var(--border); max-height: 95vh; display: flex; flex-direction: column; overflow-y: auto; }
        .modal-overlay.active .modal-sheet { transform: translateY(0); }

        footer { position: fixed; bottom: 0; left: 0; right: 0; padding: 20px; padding-bottom: calc(var(--safe-bottom) + 15px); background: linear-gradient(to top, var(--bg) 90%, transparent); z-index: 50; }
        .input-box { background: var(--card); border: 1px solid var(--border); border-radius: 30px; padding: 12px; }
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        input, select { background: var(--input-bg); border: 1px solid var(--border); color: var(--text); padding: 14px; border-radius: 18px; font-size: 15px; width: 100%; outline: none; }
    </style>
</head>
<body class="theme-midnight">

    <div id="global-loader">
        <div class="spinner"></div>
    </div>

    <div id="screen-landing" class="full-screen">
        <h1 style="font-size: 64px; letter-spacing: -4px; margin-bottom: 5px;">Agenda.</h1>
        <div class="subtitle">Private Workspace</div>

        <div class="auth-container active" id="auth-main">
            <button class="btn-prime btn-save" onclick="showAuth('auth-login')">Sign In</button>
            <button class="btn-prime btn-ghost" onclick="showAuth('auth-signup')">Create Account</button>
            <div style="margin: 20px 0; color: var(--dim); font-size: 12px; font-weight:800;">OR</div>
            <button class="btn-prime" style="background:#fff; color:#000;" onclick="handleGoogleLogin()">
                <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" style="width:18px;">
                Continue with Google
            </button>
        </div>

        <div class="auth-container" id="auth-signup">
            <h2>New Account</h2>
            <div style="display:flex; gap:10px;">
                <input type="text" id="su-first" placeholder="First">
                <input type="text" id="su-last" placeholder="Last">
            </div>
            <input type="email" id="su-email" placeholder="Email Address">
            <input type="password" id="su-pass" placeholder="Password">
            <input type="password" id="su-repass" placeholder="Confirm Password">
            <div class="error-msg" id="su-error"></div>
            <button class="btn-prime btn-save" id="signup-btn" onclick="handleSignUpProcess()">Sign Up</button>
            <button class="btn-prime btn-ghost" onclick="showAuth('auth-main')">Back</button>
        </div>

        <div class="auth-container" id="auth-login">
            <h2>Welcome Back</h2>
            <input type="email" id="li-email" placeholder="Email">
            <input type="password" id="li-pass" placeholder="Password">
            <div class="error-msg" id="li-error"></div>
            <button class="btn-prime btn-save" onclick="handleEmailLogin()">Sign In</button>
            <button class="btn-prime btn-ghost" onclick="showAuth('auth-main')">Back</button>
        </div>

        <div class="auth-container" id="auth-verify">
            <h2>Verify Email</h2>
            <p style="color:var(--dim); font-size:14px;">Verification code sent to email.</p>
            <input type="text" id="v-code" placeholder="000000" maxlength="6" style="text-align:center; font-size:32px; letter-spacing:8px;">
            <div class="error-msg" id="v-error"></div>
            <button class="btn-prime btn-save" onclick="validateCode()">Verify Account</button>
        </div>
    </div>

    <div id="screen-intro" class="full-screen">
        <div class="auth-container active">
            <h2 id="intro-welcome">Welcome!</h2>
            <p style="color:var(--dim); margin-bottom:20px;">Let's set up your first agenda.</p>
            <input type="text" id="intro-agenda-name" placeholder="e.g. Work, School">
            <button class="btn-prime btn-save" onclick="completeOnboarding()" style="margin-top:20px;">Complete Setup</button>
        </div>
    </div>

    <div id="app-shell">
        <header>
            <div class="header-top">
                <h1 id="app-header-title">Agenda</h1>
                <div style="display:flex; gap:15px;">
                    <div class="icon-btn" onclick="openModal('modal-new-list')"><svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg></div>
                    <div class="icon-btn" onclick="openModal('modal-settings')"><svg viewBox="0 0 24 24"><path d="M12 15a3 3 0 100-6 3 3 0 000 6z"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg></div>
                </div>
            </div>
            <div class="nav-scroller" id="tab-bar"></div>
        </header>
        <main id="main-content"></main>
        <footer>
            <div class="input-box">
                <div class="input-row">
                    <input type="text" id="t-input" placeholder="Event name...">
                    <input type="date" id="d-input" style="width:145px;">
                </div>
                <button class="btn-prime btn-add" id="s-btn" onclick="handleTaskSubmit()">Add to Agenda</button>
                <button class="btn-prime" id="cancel-edit" style="display:none; margin-top:8px; background:var(--dim); color:white;" onclick="resetForm()">Cancel</button>
            </div>
        </footer>
    </div>

    <div id="modal-settings" class="modal-overlay" onclick="closeAllModals()">
        <div class="modal-sheet" onclick="event.stopPropagation()">
            <h2 style="margin-bottom:10px;">Settings</h2>
            <div id="account-display" style="padding:15px; background:var(--bg); border-radius:20px; margin-bottom:20px; display:flex; align-items:center; gap:15px;">
                <img id="user-photo" src="" style="width:45px; height:45px; border-radius:50%; border:2px solid var(--accent);">
                <div><b id="user-name">User</b><br><span id="user-email" style="font-size:12px; color:var(--dim);"></span></div>
            </div>

            <p style="font-size:10px; font-weight:900; color:var(--accent); text-transform:uppercase;">Accounts</p>
            <button class="btn-prime" onclick="handleSwitchAccount()" style="background:var(--input-bg); border:1px solid var(--border); color:var(--text); margin-bottom:15px;">
                Switch Account
            </button>

            <p style="font-size:10px; font-weight:900; color:var(--accent); text-transform:uppercase;">Theme</p>
            <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; margin-bottom:20px;">
                <button class="tab-pill" onclick="updateTheme('theme-midnight')">Midnight</button>
                <button class="tab-pill" onclick="updateTheme('theme-solar')">Solar</button>
                <button class="tab-pill" onclick="updateTheme('theme-cyber')">Cyber</button>
                <button class="tab-pill" onclick="updateTheme('theme-forest')">Forest</button>
                <button class="tab-pill" onclick="updateTheme('theme-silver')">Silver</button>
            </div>
            
            <p style="font-size:10px; font-weight:900; color:var(--accent); text-transform:uppercase;">My Agendas</p>
            <div id="settings-agendas-list"></div>
            
            <button class="btn-prime" onclick="auth.signOut()" style="background:var(--card); border:1px solid var(--border); margin-top:25px; color:var(--text);">Log Out</button>
            <button class="btn-prime btn-danger" onclick="openModal('modal-confirm-delete')" style="margin-top:10px;">Delete Account</button>
        </div>
    </div>

    <div id="modal-confirm-delete" class="modal-overlay" onclick="closeAllModals()">
        <div class="modal-sheet" onclick="event.stopPropagation()">
            <h2 style="color:var(--error);">Final Warning</h2>
            <p style="color:var(--dim); font-size:14px; margin-bottom:25px;">This will permanently wipe all your agendas and data. To confirm, please type your email below:</p>
            <input type="email" id="delete-confirm-email" placeholder="Your Email Address" style="margin-bottom:20px; border-color:var(--error);">
            <div class="error-msg" id="del-error"></div>
            <button class="btn-prime btn-save" style="background:var(--error); color:#fff;" onclick="handleDeleteAccount()">Wipe Everything</button>
            <button class="btn-prime btn-ghost" onclick="closeAllModals()">Cancel</button>
        </div>
    </div>

    <div id="modal-new-list" class="modal-overlay" onclick="closeAllModals()">
        <div class="modal-sheet" onclick="event.stopPropagation()">
            <h2>New Agenda</h2>
            <input type="text" id="n-list-name" placeholder="Name (e.g. Travel)">
            <p style="font-size:10px; font-weight:900; color:var(--accent); text-transform:uppercase; margin-top:15px;">Agenda Type</p>
            <select id="n-list-type" style="margin-bottom: 20px;">
                <option value="Standard">Standard List</option>
                <option value="Countdown">Countdown (Days until)</option>
                <option value="Finance">Finance ($ Amount)</option>
            </select>
            <button class="btn-prime btn-save" onclick="createNewAgenda()">Create</button>
        </div>
    </div>

    <script>
        const EMAILJS_SERVICE_ID = "service_ow9m3kg";
        const EMAILJS_TEMPLATE_ID = "template_7xhxmoi";
        const EMAILJS_PUBLIC_KEY = "RsAYqiwym2mViUR8u";

        const firebaseConfig = {
            apiKey: "AIzaSyCEdkitaytyO0ZHL-bbU0R1p_oy8E1RhbY",
            authDomain: "plannerapp-ff221.firebaseapp.com",
            projectId: "plannerapp-ff221",
            storageBucket: "plannerapp-ff221.appspot.com",
            messagingSenderId: "282165391993",
            appId: "1:282165391993:web:cd1b9e50b03a68edfb9aa8"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        emailjs.init(EMAILJS_PUBLIC_KEY);

        let activeTab = 'General';
        let allTasks = [];
        let agendas = [];
        let editId = null;
        let vCode = "";
        let signupTemp = null;

        const trashSvg = `<svg class="trash-icon" viewBox="0 0 24 24"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2M10 11v6M14 11v6"/></svg>`;

        // UI HELPERS
        function setVisibility(screen) {
            const loader = document.getElementById('global-loader');
            const landing = document.getElementById('screen-landing');
            const intro = document.getElementById('screen-intro');
            const shell = document.getElementById('app-shell');

            loader.style.opacity = '0';
            setTimeout(() => loader.style.display = 'none', 500);

            landing.style.display = (screen === 'landing') ? 'flex' : 'none';
            intro.style.display = (screen === 'intro') ? 'flex' : 'none';
            shell.style.display = (screen === 'app') ? 'flex' : 'none';
            
            if(screen === 'app') setTimeout(() => shell.classList.add('ready'), 50);
            else shell.classList.remove('ready');
        }

        function showAuth(id) {
            document.querySelectorAll('.auth-container').forEach(c => c.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // AUTH ENGINE
        auth.onAuthStateChanged(async user => {
            if (user) {
                const doc = await db.collection('users').doc(user.uid).get();
                if(!doc.exists) {
                    setVisibility('intro');
                    document.getElementById('intro-welcome').innerText = `Hi, ${user.displayName ? user.displayName.split(' ')[0] : 'there'}!`;
                } else {
                    initApp(user, doc.data());
                }
            } else {
                setVisibility('landing');
            }
        });

        async function handleEmailLogin() {
            const e = document.getElementById('li-email').value.trim();
            const p = document.getElementById('li-pass').value;
            if(!e || !p) return;
            auth.signInWithEmailAndPassword(e, p).catch(err => { document.getElementById('li-error').innerText = "Incorrect login details."; });
        }

        async function handleGoogleLogin() {
            try { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); } catch(e) {}
        }

        async function handleSwitchAccount() {
            await auth.signOut();
            setVisibility('landing');
            showAuth('auth-main');
        }

        async function handleSignUpProcess() {
            const f = document.getElementById('su-first').value.trim();
            const l = document.getElementById('su-last').value.trim();
            const e = document.getElementById('su-email').value.trim();
            const p = document.getElementById('su-pass').value;
            const rp = document.getElementById('su-repass').value;
            const err = document.getElementById('su-error');
            const btn = document.getElementById('signup-btn');

            if(!f || !e || !p) return err.innerText = "Please fill all fields.";
            if(p !== rp) return err.innerText = "Passwords do not match.";

            signupTemp = { email: e, pass: p, name: `${f} ${l}` };
            vCode = Math.floor(100000 + Math.random() * 900000).toString();

            btn.innerText = "Sending Code...";
            btn.disabled = true;

            try {
                await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
                    to_email: e,
                    verification_code: vCode,
                    user_name: signupTemp.name
                });
                showAuth('auth-verify');
            } catch (error) {
                err.innerText = "Verification failed to send.";
            } finally {
                btn.innerText = "Sign Up";
                btn.disabled = false;
            }
        }

        async function validateCode() {
            const input = document.getElementById('v-code').value;
            if(input === vCode) {
                try {
                    const res = await auth.createUserWithEmailAndPassword(signupTemp.email, signupTemp.pass);
                    await res.user.updateProfile({ displayName: signupTemp.name });
                } catch(e) { document.getElementById('v-error').innerText = e.message; }
            } else {
                document.getElementById('v-error').innerText = "Incorrect verification code.";
            }
        }

        // ACCOUNT DELETION (FIXED)
        async function handleDeleteAccount() {
            const user = auth.currentUser;
            const confirmEmail = document.getElementById('delete-confirm-email').value.trim();
            const err = document.getElementById('del-error');

            if (confirmEmail !== user.email) {
                err.innerText = "Email does not match current user.";
                return;
            }

            if (!confirm("Are you absolutely sure? This cannot be undone.")) return;

            document.getElementById('global-loader').style.display = 'flex';
            document.getElementById('global-loader').style.opacity = '1';

            try {
                // 1. Delete Firestore Data
                const taskSnap = await db.collection('tasks').where('uid', '==', user.uid).get();
                const batch = db.batch();
                taskSnap.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                await db.collection('users').doc(user.uid).delete();

                // 2. Delete Auth User
                await user.delete();
                location.reload();
            } catch (e) {
                document.getElementById('global-loader').style.display = 'none';
                if (e.code === 'auth/requires-recent-login') {
                    err.innerText = "Security error: Please log out and back in, then try again immediately.";
                } else {
                    err.innerText = "Error: " + e.message;
                }
            }
        }

        // APP LOGIC
        async function completeOnboarding() {
            const name = document.getElementById('intro-agenda-name').value.trim() || "Tasks";
            const data = { theme: 'theme-midnight', agendas: [{id: name, type: 'Standard'}] };
            await db.collection('users').doc(auth.currentUser.uid).set(data);
            initApp(auth.currentUser, data);
        }

        function initApp(user, data) {
            document.getElementById('user-photo').src = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName}&background=random`;
            document.getElementById('user-name').innerText = user.displayName || "User";
            document.getElementById('user-email').innerText = user.email;
            agendas = data.agendas || [];
            activeTab = agendas[0]?.id || 'General';
            document.body.className = data.theme || 'theme-midnight';
            
            db.collection("tasks").where("uid", "==", user.uid).onSnapshot(snap => {
                allTasks = snap.docs.map(d => ({id: d.id, ...d.data()}));
                render();
            });
            setVisibility('app');
        }

        async function updateTheme(t) {
            document.body.className = t;
            await db.collection('users').doc(auth.currentUser.uid).update({ theme: t });
        }

        // MODAL SYSTEM
        window.openModal = (id) => {
            const m = document.getElementById(id);
            m.style.display = 'flex';
            setTimeout(() => { m.classList.add('active'); document.getElementById('app-shell').classList.add('modal-active'); }, 10);
            if(id === 'modal-settings') renderSettingsList();
        };

        window.closeAllModals = () => {
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
            document.getElementById('app-shell').classList.remove('modal-active');
            setTimeout(() => document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'), 400);
        };

        // CRUD
        function handleTaskSubmit() {
            const name = document.getElementById('t-input').value;
            const date = document.getElementById('d-input').value;
            if(!name || !date) return;
            const data = { name, date, category: activeTab, uid: auth.currentUser.uid };
            
            if (editId) {
                db.collection("tasks").doc(editId).update(data);
                resetForm();
            } else {
                db.collection("tasks").add(data);
                document.getElementById('t-input').value = '';
            }
        }

        function startEdit(id) {
            const t = allTasks.find(x => x.id === id);
            document.getElementById('t-input').value = t.name;
            document.getElementById('d-input').value = t.date;
            editId = id;
            document.getElementById('s-btn').innerText = "Update";
            document.getElementById('cancel-edit').style.display = "block";
        }

        function resetForm() {
            editId = null;
            document.getElementById('t-input').value = '';
            document.getElementById('d-input').value = '';
            document.getElementById('s-btn').innerText = "Add to Agenda";
            document.getElementById('cancel-edit').style.display = "none";
        }

        async function createNewAgenda() {
            const n = document.getElementById('n-list-name').value.trim();
            const t = document.getElementById('n-list-type').value;
            if(!n) return;
            agendas.push({id: n, type: t});
            activeTab = n;
            await db.collection('users').doc(auth.currentUser.uid).update({agendas});
            document.getElementById('n-list-name').value = '';
            closeAllModals();
            render();
        }

        async function deleteAgenda(id) {
            if(agendas.length <= 1) return alert("You must keep at least one agenda.");
            if(!confirm('Delete this entire agenda?')) return;
            agendas = agendas.filter(x => x.id !== id);
            activeTab = agendas[0].id;
            await db.collection('users').doc(auth.currentUser.uid).update({agendas});
            render(); renderSettingsList();
        }

        function renderSettingsList() {
            document.getElementById('settings-agendas-list').innerHTML = agendas.map(a => `
                <div style="display:flex; justify-content:space-between; padding:15px; background:var(--bg); margin-bottom:5px; border-radius:12px;">
                    <span>${a.id}</span>
                    <div onclick="deleteAgenda('${a.id}')">${trashSvg}</div>
                </div>
            `).join('');
        }

        function render() {
            const tabBar = document.getElementById('tab-bar');
            tabBar.innerHTML = agendas.map(a => `
                <div class="tab-pill ${a.id === activeTab ? 'active' : ''}" onclick="activeTab='${a.id}'; render();">${a.id}</div>
            `).join('');
            
            const curType = agendas.find(a => a.id === activeTab)?.type || 'Standard';
            const filtered = allTasks.filter(t => t.category === activeTab).sort((a,b) => new Date(a.date) - new Date(b.date));
            const main = document.getElementById('main-content');
            main.innerHTML = '';

            const groups = {};
            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            
            filtered.forEach(t => {
                const d = new Date(t.date + "T00:00:00");
                const key = `${months[d.getMonth()]} ${d.getFullYear()}`;
                if (!groups[key]) groups[key] = [];
                groups[key].push(t);
            });

            for (const key in groups) {
                const sec = document.createElement('div');
                sec.style.marginBottom = "30px";
                sec.innerHTML = `<div class="month-label">${key}</div>`;
                
                groups[key].forEach(task => {
                    const target = new Date(task.date + "T00:00:00");
                    const diff = Math.ceil((target - new Date()) / 86400000);
                    let badge = '', displayTitle = task.name;

                    if (curType === 'Countdown') badge = `<div style="font-size:12px; font-weight:900; color:var(--accent);">${diff < 0 ? 'PAST' : diff + 'd'}</div>`;
                    else if (curType === 'Finance') displayTitle = `$${task.name}`;

                    const card = document.createElement('div');
                    card.className = 'card';
                    card.onclick = () => startEdit(task.id);
                    card.innerHTML = `
                        <div class="card-body"><b>${displayTitle}</b><span>${task.date}</span></div>
                        <div style="display:flex; align-items:center; gap:16px;">
                            ${badge}
                            <div style="padding:10px;" onclick="event.stopPropagation(); if(confirm('Delete Task?')) db.collection('tasks').doc('${task.id}').delete();">${trashSvg}</div>
                        </div>`;
                    sec.appendChild(card);
                });
                main.appendChild(sec);
            }
        }
    </script>
</body>
</html>
