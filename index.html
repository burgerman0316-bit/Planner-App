<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Agenda Pro | Full Production V4.5</title>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --bg: #000; --card: #121212; --border: #282828; --text: #ffffff;
            --dim: #777; --accent: #ffd60a; --error: #ff453a; --success: #32d74b;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* Auth Gate Styling */
        #auth-gate { 
            position: fixed; inset: 0; background: #000; z-index: 10000; 
            display: flex; flex-direction: column; align-items: center; 
            justify-content: center; padding: 30px; overflow-y: auto;
        }
        
        .auth-container { width: 100%; max-width: 360px; text-align: center; }
        .logo { font-size: 56px; font-weight: 900; letter-spacing: -4px; margin: 0 0 40px 0; }

        /* Provider Buttons */
        .btn-stack { width: 100%; display: flex; flex-direction: column; gap: 10px; margin-bottom: 25px; }
        .btn-auth { 
            width: 100%; padding: 16px; border-radius: 14px; border: none; 
            font-weight: 700; cursor: pointer; font-size: 14px; 
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-google { background: #fff; color: #000; }
        .btn-github { background: #24292e; color: #fff; }
        .btn-discord { background: #5865F2; color: #fff; }
        .btn-phone { background: #333; color: #fff; }
        
        /* Email/Password Form */
        .email-form { 
            background: #0a0a0a; border: 1px solid var(--border); 
            padding: 20px; border-radius: 20px; text-align: left;
            margin-top: 10px;
        }
        .email-form label { font-size: 11px; color: var(--dim); text-transform: uppercase; font-weight: 800; margin-left: 5px; }
        .email-form input { 
            width: 100%; background: #1a1a1a; border: 1px solid var(--border); 
            color: #fff; padding: 14px; border-radius: 10px; margin: 5px 0 15px 0; outline: none;
        }
        .btn-login { width: 100%; background: var(--accent); color: #000; border: none; padding: 14px; border-radius: 10px; font-weight: 800; cursor: pointer; }
        .form-switch { font-size: 12px; color: var(--dim); text-align: center; margin-top: 15px; cursor: pointer; }

        /* Main App UI */
        #app-shell { display: none; flex-direction: column; height: 100vh; }
        header { padding: calc(var(--safe-top) + 20px) 25px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        main { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 280px; }
        
        .task-card { 
            background: var(--card); border: 1px solid var(--border); 
            border-radius: 20px; padding: 18px; margin-bottom: 12px; 
            display: flex; justify-content: space-between; align-items: center;
        }

        footer { 
            position: fixed; bottom: 0; width: 100%; padding: 20px; 
            padding-bottom: calc(var(--safe-bottom) + 20px);
            background: linear-gradient(to top, #000 80%, transparent);
        }
        .input-panel { background: #080808; border: 1px solid var(--border); border-radius: 28px; padding: 12px; display: flex; flex-direction: column; gap: 8px; }
        .input-panel input { background: transparent; border: none; color: #fff; padding: 10px; font-size: 16px; outline: none; }
        .btn-submit { background: var(--accent); color: #000; border: none; padding: 16px; border-radius: 18px; font-weight: 900; cursor: pointer; }
        
        #recaptcha-container { display: none; }
    </style>
</head>
<body>

    <div id="auth-gate">
        <div class="auth-container">
            <h1 class="logo">Agenda.</h1>
            
            <div class="btn-stack">
                <button class="btn-auth btn-google" onclick="socialAuth('google')">Continue with Google</button>
                <button class="btn-auth btn-github" onclick="socialAuth('github')">Continue with GitHub</button>
                <button class="btn-auth btn-discord" onclick="socialAuth('discord')">Continue with Discord</button>
                <button class="btn-auth btn-phone" onclick="phoneAuthFlow()">Use Phone SMS</button>
            </div>

            <div class="email-form">
                <label>Email Address</label>
                <input type="email" id="email-in" placeholder="name@example.com">
                <label>Password</label>
                <input type="password" id="pass-in" placeholder="••••••••">
                <button class="btn-login" id="main-auth-btn" onclick="emailPasswordAuth()">Sign In / Sign Up</button>
                <div class="form-switch" onclick="alert('Just enter your details. If the account exists, we log you in. If not, we create it!')">
                    New here? Just enter an email & password to start.
                </div>
            </div>
        </div>
        <div id="recaptcha-container"></div>
    </div>

    <div id="app-shell">
        <header>
            <div>
                <h2 id="display-name" style="margin:0; font-size:28px;">My Day</h2>
            </div>
            <button onclick="auth.signOut()" style="background:none; border:none; color:var(--error); font-weight:800; font-size:12px;">LOGOUT</button>
        </header>

        <main id="task-list"></main>

        <footer>
            <div class="input-panel">
                <input type="text" id="task-title" placeholder="Add a new task...">
                <input type="date" id="task-date">
                <button class="btn-submit" onclick="saveTask()">Save to Agenda</button>
            </div>
        </footer>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCEdkitaytyO0ZHL-bbU0R1p_oy8E1RhbY",
            authDomain: "plannerapp-ff221.firebaseapp.com",
            projectId: "plannerapp-ff221",
            storageBucket: "plannerapp-ff221.appspot.com",
            messagingSenderId: "282165391993",
            appId: "1:282165391993:web:cd1b9e50b03a68edfb9aa8"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // 1. Social Auth Handler (Google, GitHub, Discord-Yahoo)
        async function socialAuth(type) {
            let provider;
            if (type === 'google') provider = new firebase.auth.GoogleAuthProvider();
            if (type === 'github') provider = new firebase.auth.GithubAuthProvider();
            if (type === 'discord') provider = new firebase.auth.OAuthProvider('yahoo.com');
            
            try { await auth.signInWithPopup(provider); } catch(e) { alert(e.message); }
        }

        // 2. Traditional Email & Password Handler
        async function emailPasswordAuth() {
            const email = document.getElementById('email-in').value;
            const pass = document.getElementById('pass-in').value;
            if(!email || !pass) return alert("Please fill in both fields.");

            try {
                // Try logging in first
                await auth.signInWithEmailAndPassword(email, pass);
            } catch (error) {
                // If account doesn't exist, try creating it
                if (error.code === 'auth/user-not-found') {
                    try {
                        await auth.createUserWithEmailAndPassword(email, pass);
                    } catch (e) { alert("Registration Error: " + e.message); }
                } else {
                    alert("Login Error: " + error.message);
                }
            }
        }

        // 3. Phone SMS Handler
        async function phoneAuthFlow() {
            const num = prompt("Phone Number (with + country code):");
            if (!num) return;
            const verifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {size: 'invisible'});
            const confirmation = await auth.signInWithPhoneNumber(num, verifier);
            const code = prompt("Enter the code from your SMS:");
            await confirmation.confirm(code);
        }

        // --- Auth State Monitor ---
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('auth-gate').style.display = 'none';
                document.getElementById('app-shell').style.display = 'flex';
                document.getElementById('display-name').innerText = user.displayName || user.email.split('@')[0] || user.phoneNumber;
                loadTasks(user.uid);
            } else {
                document.getElementById('auth-gate').style.display = 'flex';
                document.getElementById('app-shell').style.display = 'none';
            }
        });

        function saveTask() {
            const name = document.getElementById('task-title').value;
            const date = document.getElementById('task-date').value;
            if(!name || !date) return;
            
            db.collection("tasks").add({
                name, date,
                uid: auth.currentUser.uid,
                created: Date.now()
            });
            document.getElementById('task-title').value = '';
        }

        function loadTasks(uid) {
            db.collection("tasks").where("uid", "==", uid).orderBy("created", "desc").onSnapshot(snap => {
                const list = document.getElementById('task-list');
                list.innerHTML = snap.docs.map(doc => {
                    const t = doc.data();
                    return `
                        <div class="task-card">
                            <div>
                                <div style="font-weight:700; font-size:18px;">${t.name}</div>
                                <div style="color:var(--dim); font-size:12px; margin-top:4px;">${t.date}</div>
                            </div>
                            <button onclick="db.collection('tasks').doc('${doc.id}').delete()" style="background:none; border:none; color:var(--error); font-size:22px;">✕</button>
                        </div>
                    `;
                }).join('');
            });
        }
    </script>
</body>
</html>
