<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Agenda Pro | OS</title>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --bg: #000; --card: #1c1c1e; --border: #2c2c2e;
            --text: #ffffff; --dim: #8e8e93; --accent: #ffd60a;
            --safe-top: env(safe-area-inset-top);
        }

        /* Full Theme Library */
        body.theme-midnight { --bg: #000000; --card: #111; --accent: #5856d6; }
        body.theme-emerald { --bg: #040d06; --card: #0d1a10; --accent: #34c759; }
        body.theme-sunset { --bg: #0d0404; --card: #1a0d0d; --accent: #ff375f; }
        body.theme-ocean { --bg: #040b0d; --card: #0d161a; --accent: #0a84ff; }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; background: var(--bg); color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow: hidden; height: 100vh;
        }

        /* Layout Structure */
        #app-shell { display: none; flex-direction: column; height: 100vh; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), filter 0.4s; }
        #app-shell.modal-open { transform: scale(0.95); filter: blur(15px); pointer-events: none; }

        header { padding: calc(var(--safe-top) + 15px) 20px 10px; background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); }
        .nav-scroller { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .nav-scroller::-webkit-scrollbar { display: none; }

        .tab { 
            padding: 8px 20px; border-radius: 40px; background: var(--card); color: var(--dim); 
            font-size: 14px; font-weight: 600; white-space: nowrap; border: 1px solid var(--border);
            transition: 0.2s;
        }
        .tab.active { background: var(--accent); color: #000; border-color: var(--accent); }

        /* Content Area */
        main { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 250px; }
        .month-section { margin-bottom: 25px; }
        .month-title { 
            font-size: 11px; text-transform: uppercase; letter-spacing: 1.5px; 
            color: var(--accent); margin-bottom: 12px; padding-left: 5px; font-weight: 800;
        }

        .card { 
            background: var(--card); border-radius: 20px; padding: 18px; 
            margin-bottom: 12px; border: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            animation: slideUp 0.4s ease forwards;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card-info b { display: block; font-size: 17px; margin-bottom: 4px; }
        .card-info span { color: var(--dim); font-size: 13px; }
        .badge { background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 700; }

        /* Custom Modal System */
        .modal-layer { 
            position: fixed; inset: 0; z-index: 1000; visibility: hidden; opacity: 0;
            display: flex; align-items: flex-end; transition: 0.3s;
        }
        .modal-layer.active { visibility: visible; opacity: 1; }
        .modal-sheet { 
            background: var(--card); width: 100%; border-radius: 30px 30px 0 0; 
            padding: 30px; transform: translateY(100%); transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            border-top: 1px solid var(--border);
        }
        .modal-layer.active .modal-sheet { transform: translateY(0); }

        /* Form Elements */
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; font-size: 10px; color: var(--dim); text-transform: uppercase; margin-bottom: 8px; }
        input, select { 
            width: 100%; background: #000; border: 1px solid var(--border); 
            color: #fff; padding: 15px; border-radius: 15px; font-size: 16px;
        }

        .btn-prime { 
            width: 100%; padding: 18px; border-radius: 18px; border: none; 
            font-weight: 800; font-size: 15px; text-transform: uppercase;
            background: #fff; color: #000; 
        }

        /* Footer Fixed */
        footer { 
            position: fixed; bottom: 0; left: 0; right: 0; padding: 20px; 
            background: linear-gradient(transparent, var(--bg) 40%);
        }
    </style>
</head>
<body>

<div id="modal-settings" class="modal-layer" onclick="closeAllModals()">
    <div class="modal-sheet" onclick="event.stopPropagation()">
        <h2 style="margin-top:0">Settings</h2>
        <div class="input-group">
            <label>Color Appearance</label>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
                <button class="tab" onclick="setTheme('theme-midnight')">Midnight</button>
                <button class="tab" onclick="setTheme('theme-emerald')">Emerald</button>
                <button class="tab" onclick="setTheme('theme-sunset')">Sunset</button>
                <button class="tab" onclick="setTheme('theme-ocean')">Ocean</button>
            </div>
        </div>
        <button class="btn-prime" onclick="auth.signOut()">Sign Out</button>
    </div>
</div>

<div id="modal-add-list" class="modal-layer" onclick="closeAllModals()">
    <div class="modal-sheet" onclick="event.stopPropagation()">
        <h2>New Agenda</h2>
        <div class="input-group">
            <label>Name</label>
            <input type="text" id="listNameInput" placeholder="Work, Fitness, Releases...">
        </div>
        <div class="input-group">
            <label>Agenda Type</label>
            <select id="listTypeInput">
                <option value="Standard">Standard List</option>
                <option value="Countdown">Countdown (Days Left)</option>
                <option value="Journal">Journal (Log)</option>
            </select>
        </div>
        <button class="btn-prime" style="background:var(--accent)" onclick="createNewList()">Create Agenda</button>
    </div>
</div>

<div id="app-shell">
    <header>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h1 style="margin:0; font-size:24px;">Agenda</h1>
            <div style="display:flex; gap:15px">
                <span onclick="openModal('modal-add-list')" style="font-size:24px; cursor:pointer">+</span>
                <span onclick="openModal('modal-settings')" style="font-size:22px; cursor:pointer">⚙️</span>
            </div>
        </div>
        <div class="nav-scroller" id="tab-bar"></div>
    </header>

    <main id="main-content"></main>

    <footer>
        <div style="background:var(--card); padding:15px; border-radius:25px; border:1px solid var(--border)">
            <div style="display:flex; gap:10px; margin-bottom:10px">
                <input type="text" id="taskName" placeholder="Event Name...">
                <input type="date" id="taskDate" style="width:140px">
            </div>
            <button class="btn-prime" id="actionBtn" onclick="saveTask()">Add to List</button>
        </div>
    </footer>
</div>

<div id="login-screen" style="height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; background:#000">
    <h1 style="font-size:40px; margin-bottom:30px">Agenda.</h1>
    <button class="btn-prime" style="width:auto; padding:15px 40px" onclick="auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())">Sign In with Google</button>
</div>

<script>
    // 1. Firebase Logic
    const config = {
        apiKey: "AIzaSyCEdkitaytyO0ZHL-bbU0R1p_oy8E1RhbY",
        authDomain: "plannerapp-ff221.firebaseapp.com",
        projectId: "plannerapp-ff221",
        storageBucket: "plannerapp-ff221.appspot.com",
        messagingSenderId: "282165391993",
        appId: "1:282165391993:web:cd1b9e50b03a68edfb9aa8"
    };
    firebase.initializeApp(config);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let state = {
        activeTab: 'Assignments',
        planners: [
            {id: 'Assignments', type: 'Standard'},
            {id: 'Game Releases', type: 'Countdown'}
        ],
        tasks: [],
        editId: null
    };

    // 2. Auth State
    auth.onAuthStateChanged(user => {
        if(user) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-shell').style.display = 'flex';
            initData(user.uid);
        } else {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('app-shell').style.display = 'none';
        }
    });

    // 3. UI Helpers
    function openModal(id) {
        document.getElementById(id).classList.add('active');
        document.getElementById('app-shell').classList.add('modal-open');
    }
    function closeAllModals() {
        document.querySelectorAll('.modal-layer').forEach(m => m.classList.remove('active'));
        document.getElementById('app-shell').classList.remove('modal-open');
    }
    function setTheme(t) {
        document.body.className = t;
        localStorage.setItem('pref-theme', t);
    }
    if(localStorage.getItem('pref-theme')) setTheme(localStorage.getItem('pref-theme'));

    // 4. Data Logic
    function initData(uid) {
        db.collection("tasks").where("uid", "==", uid).onSnapshot(snap => {
            state.tasks = snap.docs.map(d => ({id: d.id, ...d.data()}));
            render();
        });
    }

    function createNewList() {
        const name = document.getElementById('listNameInput').value;
        const type = document.getElementById('listTypeInput').value;
        if(!name) return;
        state.planners.push({id: name, type: type});
        state.activeTab = name;
        closeAllModals();
        render();
    }

    function saveTask() {
        const name = document.getElementById('taskName').value;
        const date = document.getElementById('taskDate').value;
        if(!name || !date) return;

        const payload = {
            name, date, uid: auth.currentUser.uid, category: state.activeTab, created: Date.now()
        };

        if(state.editId) {
            db.collection("tasks").doc(state.editId).update(payload);
            state.editId = null;
            document.getElementById('actionBtn').innerText = "Add to List";
        } else {
            db.collection("tasks").add(payload);
        }
        
        document.getElementById('taskName').value = '';
        document.getElementById('taskDate').value = '';
    }

    // 5. Core Rendering (The Month & Countdown Logic)
    function render() {
        const tabBar = document.getElementById('tab-bar');
        tabBar.innerHTML = state.planners.map(p => `
            <div class="tab ${p.id === state.activeTab ? 'active' : ''}" onclick="state.activeTab='${p.id}'; render();">
                ${p.id}
            </div>
        `).join('');

        const main = document.getElementById('main-content');
        main.innerHTML = '';

        const currentType = state.planners.find(p => p.id === state.activeTab)?.type || 'Standard';
        const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        
        const filtered = state.tasks.filter(t => t.category === state.activeTab)
                         .sort((a,b) => new Date(a.date) - new Date(b.date));

        // Grouping logic
        const grouped = {};
        filtered.forEach(t => {
            const d = new Date(t.date);
            const key = `${months[d.getMonth()]} ${d.getFullYear()}`;
            if(!grouped[key]) grouped[key] = [];
            grouped[key].push(t);
        });

        for(let monthKey in grouped) {
            const section = document.createElement('div');
            section.className = 'month-section';
            section.innerHTML = `<div class="month-title">${monthKey}</div>`;
            
            grouped[monthKey].forEach(task => {
                let extra = '';
                if(currentType === 'Countdown') {
                    const diff = Math.ceil((new Date(task.date) - new Date()) / (1000*60*60*24));
                    extra = `<div class="badge" style="color:${diff < 0 ? '#ff375f' : 'var(--accent)'}">
                        ${diff < 0 ? 'Lapsed' : diff + ' Days Left'}
                    </div>`;
                }

                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-info" onclick="startEdit('${task.id}')">
                        <b>${task.name}</b>
                        <span>${task.date}</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:15px">
                        ${extra}
                        <span onclick="db.collection('tasks').doc('${task.id}').delete()" style="color:#ff375f; font-weight:bold">✕</span>
                    </div>
                `;
                section.appendChild(card);
            });
            main.appendChild(section);
        }
    }

    window.startEdit = (id) => {
        const t = state.tasks.find(x => x.id === id);
        document.getElementById('taskName').value = t.name;
        document.getElementById('taskDate').value = t.date;
        state.editId = id;
        document.getElementById('actionBtn').innerText = "Update Entry";
    };

</script>
</body>
</html>
